from django.test import TestCase

from unittest.mock import Mock
from unittest.mock import patch

import json
import datetime
import asyncio

from charts.api.bitcoin import analyze_transaction_data
#from charts.api.bitcoin import download_blockchain_data
from charts.api.bitcoin import whirlpool_analysis

TX_DATA_MISSING_KEY = '{"txid":"8509edf5742c102def3431c3d61179c52f61d555e488b8456c3b6fe4c27f46d1","hash":"86e9bb2ab1e5cba520b49bcbeee5422de227362455c4cf92868ada405de070c9","version":2,"size":933,"vsize":527,"weight":2106,"locktime":0,"vin":[{"txid":"ce4fb86613de766052387ec95e0baaf0de54484425fe923c41ee66447c7e32c0","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1qfcerkty6a60fdculaqa9hl40kkg2rmjkddm0kt","type":"witness_v0_keyhash"},"txinwitness":["3045022100d1721dae8c32a06e47b1b035f106b0715ab199dd6885c0a42ef52fb62354487c022055319c85def9318a8048e01c8d1d8817de80ee1b658ef51c9479ba03d221b41701","025767e4df8dd42e04befb7602eddaf045be89152d11d078e6700e96339f448078"],"sequence":4294967293,"value":0.00000546},{"txid":"0b96aa074e9fefb9231b824bcd476511b4788c9e1f971673b9c7811f889a5e99","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1q9c9ym2u963jgcf6ys2y875jn73pafa6537v70y","type":"witness_v0_keyhash"},"txinwitness":["3045022100d99dd65419ed36ead3416fff9346c1180c6dab4c86d1902f8f1e8858c47a304a022072fc2874813ea5713f81b47b54c9507c0d92a33c3a61953a92230df2c4a3477e01","026fc1e0618d5df490d657186a5c60047f28cf22acf1f1a8b67b3c854d81f4bfb5"],"sequence":4294967293,"value":0.00000546},{"txid":"3ea7821ac5d1ed58765330c47f888970ee53782a79c87ea23d8c0febb50fad4b","vout":0,"scriptSig":{"asm":"","hex":"","address":"bc1q988ep9cefnjhpfftcnr7hmu7g0nk6462pmz3tw","type":"witness_v0_keyhash"},"txinwitness":["3045022100dc41415f238071976bf6a4682e7227a694ba69a0d188fa6d9b149927fd820e9b0220577858a02b1ce46910fcf332c63baf9419633822af4e900347ee0251e1200f8001","0378f4df1cee712222264e093fddb5c95ce3b496eca6fc45fdd84f2f861e899384"],"sequence":4294967293,"value":0.00000546},{"txid":"cb5f4b9f9c436de709be45bf555cb55e57d95c55e3e42ff6ba3252925df8d0cb","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1qd8t4lmr6sly3z6umd58tawq53qkkhzf97n7dxr","type":"witness_v0_keyhash"},"txinwitness":["3045022100a9815b729c997030d869f20948a1ea30cef0470592dca8d8d26855d711050de5022017129042b4e7e27e70b2cca2edcc44eafeaeb9018247256d7f89745ae4edda4301","023899ddff9c06b3be35c9bd0b855bb13535bfaee29c55332393aefd229928313a"],"sequence":4294967293,"value":0.00000546},{"txid":"b7254c4625bffd579c8f77d6f2e4cc15efd00e65b85d4c010862d8704d60bcff","vout":3,"scriptSig":{"asm":"","hex":"","address":"bc1q4s9c8wzshcs9lm9hawg2sjl0mlh3xnftf3nkmn","type":"witness_v0_keyhash"},"txinwitness":["3045022100ae748fe98eef9f245b0eb01b915c619578cbe6038dfebdb1031fb68eefe8fe1a0220482499e1be0341d4a737b962e60a3124c2d525512bdfa8da5ff910908ac8a42c01","03defd15f7083751479f330b3fe8074034ff1a8de8bd12baebcbdfd46a05e1f26d"],"sequence":4294967293,"value":0.00001221}],"blockhash":"000000000000000000001cd62a95bd5c7de5c219bf01620861f532afaacce0f0","confirmations":271,"time":1752545332,"blocktime":1752545332,"fee":{"amount":0.00000527,"unit":"BTC"}}'

TX_DATA_NOT_WHIRLPOOL = '{"txid":"d4fae09b14d12f937409e683eea22ae02935d90c4aee5fafb5a49f12db5e2783","hash":"dd44f2df2bb61ad7a5d738a61b78908be57d47f44acad9fcda5256c4168e7a43","version":2,"size":378,"vsize":351,"weight":1404,"locktime":0,"vin":[{"coinbase":"0385d00d04a38873682f466f756e6472792055534120506f6f6c202364726f70676f6c642ffabe6d6dedd795db5040d2790083bb4cc320a97b0b7c0b086a2817425d7707d2de60028201000000000000005f3115a77fcd010000000000","txinwitness":["0000000000000000000000000000000000000000000000000000000000000000"],"sequence":4294967295}],"vout":[{"value":3.1432233,"n":0,"scriptPubKey":{"asm":"0 7086320071974eef5e72eaa01dd9096e10c0383483855ea6b344259c244f73c2","desc":"addr(bc1qwzrryqr3ja8w7hnja2spmkgfdcgvqwp5swz4af4ngsjecfz0w0pqud7k38)#y9upg3rz","hex":"00207086320071974eef5e72eaa01dd9096e10c0383483855ea6b344259c244f73c2","address":"bc1qwzrryqr3ja8w7hnja2spmkgfdcgvqwp5swz4af4ngsjecfz0w0pqud7k38","type":"witness_v0_scripthash"}},{"value":0,"n":1,"scriptPubKey":{"asm":"OP_RETURN aa21a9edf468d820cff9a30dbc0318aaf85c1b0f67db1ec01d1dc741ce3395c0e00f6a56","desc":"raw(6a24aa21a9edf468d820cff9a30dbc0318aaf85c1b0f67db1ec01d1dc741ce3395c0e00f6a56)#w4uz80d2","hex":"6a24aa21a9edf468d820cff9a30dbc0318aaf85c1b0f67db1ec01d1dc741ce3395c0e00f6a56","type":"nulldata"}},{"value":0,"n":2,"scriptPubKey":{"asm":"OP_RETURN 434f5245012e50087fb834747606ed01ad67ad0f32129ab431e6d18fda214e5b9f350ffc7b6cf3058b9026e765","desc":"raw(6a2d434f5245012e50087fb834747606ed01ad67ad0f32129ab431e6d18fda214e5b9f350ffc7b6cf3058b9026e765)#eyjrnxlm","hex":"6a2d434f5245012e50087fb834747606ed01ad67ad0f32129ab431e6d18fda214e5b9f350ffc7b6cf3058b9026e765","type":"nulldata"}},{"value":0,"n":3,"scriptPubKey":{"asm":"OP_RETURN 52534b424c4f434b3a79dbca11a0a7915d44e7813bb7c426524cc7006f248da5b173129b1500769986","desc":"raw(6a2952534b424c4f434b3a79dbca11a0a7915d44e7813bb7c426524cc7006f248da5b173129b1500769986)#scfrgxm7","hex":"6a2952534b424c4f434b3a79dbca11a0a7915d44e7813bb7c426524cc7006f248da5b173129b1500769986","type":"nulldata"}}],"hex":"020000000001010000000000000000000000000000000000000000000000000000000000000000ffffffff5d0385d00d04a38873682f466f756e6472792055534120506f6f6c202364726f70676f6c642ffabe6d6dedd795db5040d2790083bb4cc320a97b0b7c0b086a2817425d7707d2de60028201000000000000005f3115a77fcd010000000000ffffffff049a2dbc12000000002200207086320071974eef5e72eaa01dd9096e10c0383483855ea6b344259c244f73c20000000000000000266a24aa21a9edf468d820cff9a30dbc0318aaf85c1b0f67db1ec01d1dc741ce3395c0e00f6a5600000000000000002f6a2d434f5245012e50087fb834747606ed01ad67ad0f32129ab431e6d18fda214e5b9f350ffc7b6cf3058b9026e76500000000000000002b6a2952534b424c4f434b3a79dbca11a0a7915d44e7813bb7c426524cc7006f248da5b173129b15007699860120000000000000000000000000000000000000000000000000000000000000000000000000","blockhash":"00000000000000000001c45d9686bc4a33871e0cdaec02a2cc9ba26d908f7637","confirmations":3,"time":1752402083,"blocktime":1752402083,"fee":{"amount":-3.1432233,"unit":"BTC"}}'

TX_DATA_WHIRLPOOL = '{"txid":"8509edf5742c102def3431c3d61179c52f61d555e488b8456c3b6fe4c27f46d1","hash":"86e9bb2ab1e5cba520b49bcbeee5422de227362455c4cf92868ada405de070c9","version":2,"size":933,"vsize":527,"weight":2106,"locktime":0,"vin":[{"txid":"ce4fb86613de766052387ec95e0baaf0de54484425fe923c41ee66447c7e32c0","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1qfcerkty6a60fdculaqa9hl40kkg2rmjkddm0kt","type":"witness_v0_keyhash"},"txinwitness":["3045022100d1721dae8c32a06e47b1b035f106b0715ab199dd6885c0a42ef52fb62354487c022055319c85def9318a8048e01c8d1d8817de80ee1b658ef51c9479ba03d221b41701","025767e4df8dd42e04befb7602eddaf045be89152d11d078e6700e96339f448078"],"sequence":4294967293,"value":0.00000546},{"txid":"0b96aa074e9fefb9231b824bcd476511b4788c9e1f971673b9c7811f889a5e99","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1q9c9ym2u963jgcf6ys2y875jn73pafa6537v70y","type":"witness_v0_keyhash"},"txinwitness":["3045022100d99dd65419ed36ead3416fff9346c1180c6dab4c86d1902f8f1e8858c47a304a022072fc2874813ea5713f81b47b54c9507c0d92a33c3a61953a92230df2c4a3477e01","026fc1e0618d5df490d657186a5c60047f28cf22acf1f1a8b67b3c854d81f4bfb5"],"sequence":4294967293,"value":0.00000546},{"txid":"3ea7821ac5d1ed58765330c47f888970ee53782a79c87ea23d8c0febb50fad4b","vout":0,"scriptSig":{"asm":"","hex":"","address":"bc1q988ep9cefnjhpfftcnr7hmu7g0nk6462pmz3tw","type":"witness_v0_keyhash"},"txinwitness":["3045022100dc41415f238071976bf6a4682e7227a694ba69a0d188fa6d9b149927fd820e9b0220577858a02b1ce46910fcf332c63baf9419633822af4e900347ee0251e1200f8001","0378f4df1cee712222264e093fddb5c95ce3b496eca6fc45fdd84f2f861e899384"],"sequence":4294967293,"value":0.00000546},{"txid":"cb5f4b9f9c436de709be45bf555cb55e57d95c55e3e42ff6ba3252925df8d0cb","vout":1,"scriptSig":{"asm":"","hex":"","address":"bc1qd8t4lmr6sly3z6umd58tawq53qkkhzf97n7dxr","type":"witness_v0_keyhash"},"txinwitness":["3045022100a9815b729c997030d869f20948a1ea30cef0470592dca8d8d26855d711050de5022017129042b4e7e27e70b2cca2edcc44eafeaeb9018247256d7f89745ae4edda4301","023899ddff9c06b3be35c9bd0b855bb13535bfaee29c55332393aefd229928313a"],"sequence":4294967293,"value":0.00000546},{"txid":"b7254c4625bffd579c8f77d6f2e4cc15efd00e65b85d4c010862d8704d60bcff","vout":3,"scriptSig":{"asm":"","hex":"","address":"bc1q4s9c8wzshcs9lm9hawg2sjl0mlh3xnftf3nkmn","type":"witness_v0_keyhash"},"txinwitness":["3045022100ae748fe98eef9f245b0eb01b915c619578cbe6038dfebdb1031fb68eefe8fe1a0220482499e1be0341d4a737b962e60a3124c2d525512bdfa8da5ff910908ac8a42c01","03defd15f7083751479f330b3fe8074034ff1a8de8bd12baebcbdfd46a05e1f26d"],"sequence":4294967293,"value":0.00001221}],"vout":[{"value":0,"n":0,"scriptPubKey":{"asm":"OP_RETURN 13 00caa2338b07d38702020000c8d20103","desc":"raw(6a5d1000caa2338b07d38702020000c8d20103)#hnnu76qs","hex":"6a5d1000caa2338b07d38702020000c8d20103","type":"nulldata"}},{"value":0.00000546,"n":1,"scriptPubKey":{"asm":"0 4e323b2c9aee9e96e39fe83a5bfeafb590a1ee56","desc":"addr(bc1qfcerkty6a60fdculaqa9hl40kkg2rmjkddm0kt)#pllfvawp","hex":"00144e323b2c9aee9e96e39fe83a5bfeafb590a1ee56","address":"bc1qfcerkty6a60fdculaqa9hl40kkg2rmjkddm0kt","type":"witness_v0_keyhash"}},{"value":0.00000546,"n":2,"scriptPubKey":{"asm":"1 3ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf","desc":"rawtr(3ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf)#z6j76qt6","hex":"51203ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf","address":"bc1p8tjvsvk2mnzemrmtavqdushnanqnqn5qfwl3397qu50myd9u92hsrqzzwc","type":"witness_v1_taproot"}},{"value":0.00000546,"n":3,"scriptPubKey":{"asm":"1 3ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf","desc":"rawtr(3ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf)#z6j76qt6","hex":"51203ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf","address":"bc1p8tjvsvk2mnzemrmtavqdushnanqnqn5qfwl3397qu50myd9u92hsrqzzwc","type":"witness_v1_taproot"}},{"value":0.0000124,"n":4,"scriptPubKey":{"asm":"0 ac0b83b850be205fecb7eb90a84befdfef134d2b","desc":"addr(bc1q4s9c8wzshcs9lm9hawg2sjl0mlh3xnftf3nkmn)#rr5har7m","hex":"0014ac0b83b850be205fecb7eb90a84befdfef134d2b","address":"bc1q4s9c8wzshcs9lm9hawg2sjl0mlh3xnftf3nkmn","type":"witness_v0_keyhash"}}],"hex":"02000000000105c0327e7c4466ee413c92fe25444854def0aa0b5ec97e38526076de1366b84fce0100000000fdffffff995e9a881f81c7b97316971f9e8c78b4116547cd4b821b23b9ef9f4e07aa960b0100000000fdffffff4bad0fb5eb0f8c3da27ec8792a7853ee7089887fc430537658edd1c51a82a73e0000000000fdffffffcbd0f85d925232baf62fe4e3555cd9575eb55c55bf45be09e76d439c9f4b5fcb0100000000fdffffffffbc604d70d86208014c5db8650ed0ef15cce4f2d6778f9c57fdbf25464c25b70300000000fdffffff050000000000000000136a5d1000caa2338b07d38702020000c8d2010322020000000000001600144e323b2c9aee9e96e39fe83a5bfeafb590a1ee5622020000000000002251203ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aaf22020000000000002251203ae4c832cadcc59d8f6beb00de42f3ecc1304e804bbf1897c0e51fb234bc2aafd804000000000000160014ac0b83b850be205fecb7eb90a84befdfef134d2b02483045022100d1721dae8c32a06e47b1b035f106b0715ab199dd6885c0a42ef52fb62354487c022055319c85def9318a8048e01c8d1d8817de80ee1b658ef51c9479ba03d221b4170121025767e4df8dd42e04befb7602eddaf045be89152d11d078e6700e96339f44807802483045022100d99dd65419ed36ead3416fff9346c1180c6dab4c86d1902f8f1e8858c47a304a022072fc2874813ea5713f81b47b54c9507c0d92a33c3a61953a92230df2c4a3477e0121026fc1e0618d5df490d657186a5c60047f28cf22acf1f1a8b67b3c854d81f4bfb502483045022100dc41415f238071976bf6a4682e7227a694ba69a0d188fa6d9b149927fd820e9b0220577858a02b1ce46910fcf332c63baf9419633822af4e900347ee0251e1200f8001210378f4df1cee712222264e093fddb5c95ce3b496eca6fc45fdd84f2f861e89938402483045022100a9815b729c997030d869f20948a1ea30cef0470592dca8d8d26855d711050de5022017129042b4e7e27e70b2cca2edcc44eafeaeb9018247256d7f89745ae4edda430121023899ddff9c06b3be35c9bd0b855bb13535bfaee29c55332393aefd229928313a02483045022100ae748fe98eef9f245b0eb01b915c619578cbe6038dfebdb1031fb68eefe8fe1a0220482499e1be0341d4a737b962e60a3124c2d525512bdfa8da5ff910908ac8a42c012103defd15f7083751479f330b3fe8074034ff1a8de8bd12baebcbdfd46a05e1f26d00000000","blockhash":"000000000000000000001cd62a95bd5c7de5c219bf01620861f532afaacce0f0","confirmations":271,"time":1752545332,"blocktime":1752545332,"fee":{"amount":0.00000527,"unit":"BTC"}}'

class TestWhirlpoolAnalysis(TestCase):
    '''Testing Bitcoin Whirlpool Analysis'''

    def test_analyze_transaction_data_whirlpool_transaction(self):

        tx_data = json.loads(TX_DATA_WHIRLPOOL)

        got = analyze_transaction_data(tx_data)
        want = "8509edf5742c102def3431c3d61179c52f61d555e488b8456c3b6fe4c27f46d1"
        self.assertEqual(got, want)

    def test_analyze_transaction_data_not_a_whirlpool_transaction(self):

        tx_data = json.loads(TX_DATA_NOT_WHIRLPOOL)

        got = analyze_transaction_data(tx_data)
        want = None
        self.assertEqual(got, want)

    def test_analyze_transaction_data_key_missing_from_json(self):

        tx_data = json.loads(TX_DATA_MISSING_KEY)

        got = analyze_transaction_data(tx_data)
        want = None
        self.assertEqual(got, want)

#    def test_download_blockchain_data(self):
#        pass

#    def test_whirlpool_analysis(self):
#        pass
